<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Symphony Entry Scanner</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ZXING QR SCANNER -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>

<body class="bg-black text-white min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md px-4 text-center space-y-5">

    <h1 class="text-2xl font-bold text-yellow-400">
      ðŸŽ¶ Symphony Entry Scanner
    </h1>
    <p class="text-sm text-zinc-400">Volunteer Access Only</p>

    <!-- CAMERA -->
    <video
      id="video"
      class="w-full rounded-lg border border-zinc-700 bg-black"
      style="height: 320px;"
      autoplay
      muted
      playsinline
    ></video>

    <!-- RESULT -->
    <div
      id="result"
      class="hidden rounded-xl p-6 text-center space-y-2"
    >
      <p id="resultTitle" class="text-2xl font-bold"></p>
      <p id="resultToken" class="text-sm"></p>
    </div>

  </div>

  <div class="mt-4 space-y-2">
    <p class="text-xs text-zinc-400">
      QR not scanning? Enter token manually
    </p>

    <input
      id="manualToken"
      type="text"
      placeholder="GYM-SYM-0001"
      class="w-full p-3 rounded bg-zinc-800 border border-zinc-700 text-center uppercase tracking-wider"
    />

    <button
      onclick="manualVerify()"
      class="w-full bg-indigo-600 hover:bg-indigo-700 p-3 rounded font-semibold"
    >
      Verify Token
    </button>
  </div>


<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyK5cygiXq6DSHOa06UXSa6a1UxaDqEIMyOuJgcoYL2qmk1z2-LlO_TnV4Qs-9GhRx3/exec";

/* ================= STATE ================= */
let scanning = true;
let codeReader = null;

/* ================= INIT ================= */
window.addEventListener("load", startScanner);

/* ================= SCANNER ================= */
function startScanner() {
  codeReader = new ZXing.BrowserQRCodeReader();

  codeReader.decodeFromVideoDevice(
    null,
    document.getElementById("video"),
    (result, err) => {
      if (!scanning) return;

      if (result) {
        scanning = false;

        const raw = String(result.text || "").trim();

        console.log("RAW QR:", raw);

        // ðŸ”‘ Extract token from ANY legacy or new QR
        const match = raw.match(/GYM-SYM-\d{4}/);

        if (!match) {
          showError("INVALID QR FORMAT");
          return;
        }

        const token = match[0];
        console.log("TOKEN EXTRACTED:", token);

        verifyToken(token);
      }
    }
  );
}

/* ================= VERIFY ================= */
async function verifyToken(token) {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "VERIFY",
        token: token
      })
    });

    const data = await res.json();
    showResult(data, token);

  } catch (e) {
    console.error(e);
    showError("NETWORK ERROR");
  }
}

/* ================= UI ================= */
function showResult(data, token) {
  const box = document.getElementById("result");
  const title = document.getElementById("resultTitle");
  const tokenEl = document.getElementById("resultToken");

  box.classList.remove("hidden");

  if (!data.success) {
    box.className = "rounded-xl p-6 bg-red-700";
    title.innerText = "INVALID PASS";
    tokenEl.innerText = token;
    return reset();
  }

  if (data.entryStatus === "ENTERED") {
    box.className = "rounded-xl p-6 bg-red-700";
    title.innerText = "ALREADY ENTERED";
    tokenEl.innerText = token;
    return reset();
  }

  if (data.status === "CONFIRMED") {
    box.className = "rounded-xl p-6 bg-green-700";
    title.innerText = "ENTRY ALLOWED";
  } else {
    box.className = "rounded-xl p-6 bg-yellow-500 text-black";
    title.innerText = "PAYMENT PENDING";
  }

  tokenEl.innerText = token;
  reset();
}

function showError(msg) {
  const box = document.getElementById("result");
  box.className = "rounded-xl p-6 bg-red-700";
  box.classList.remove("hidden");
  document.getElementById("resultTitle").innerText = msg;
  document.getElementById("resultToken").innerText = "";
  reset();
}

/* ================= RESET ================= */
function reset() {
  setTimeout(() => {
    scanning = true;
    document.getElementById("result").classList.add("hidden");
  }, 2500);
}

function manualVerify() {
  const input = document.getElementById("manualToken");
  const raw = input.value.trim().toUpperCase();

  const match = raw.match(/GYM-SYM-\d{4}/);

  if (!match) {
    showError("INVALID TOKEN FORMAT");
    return;
  }

  scanning = false;
  verifyToken(match[0]);
}

</script>

</body>
</html>

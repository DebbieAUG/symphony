<script type="module">
    import "https://cdn.jsdelivr.net/npm/scanbot-web-sdk@8.0.1/bundle/ScanbotSDK.ui2.min.js";

    const LICENSE_KEY =
  "O1oW6k6iHGrlKlgOt6DklijPituS9c" +
  "qIrVGzy/TmVWeSqs8pgXuhZnfUE5AW" +
  "paqIo//k455gqsFCIQj6TBFwr84Qa+" +
  "3aBCiB9VtjbPdTjxeknaLxXobB/PvN" +
  "KchNbLoq1UfbhCJP9/kMy2mAEl0VAF" +
  "wrVoEVXlzlW+8A9SWZYbsGAPzYvbzb" +
  "QnAIIhyCTBNRpU/l1FnvKUn19D/hmW" +
  "osLjBJ1+rgDY4Xbm2asibZJmzd7yOI" +
  "e9mJY0MCu9+46L5VWkVLFdcsHdrubL" +
  "GMnmtBfTvHCHvhOBPPTWH0ybCXE22B" +
  "k23iG/iVtwpjxm6Te7lLtERHk420tJ" +
  "1Pdjvmbo9pvQ==\nU2NhbmJvdFNESw" +
  "psb2NhbGhvc3R8ZGViYmllYXVnLmdp" +
  "dGh1Yi5pbwoxNzcwMjQ5NTk5CjgzOD" +
  "g2MDcKOA==\n";
  
    const cdn = "https://cdn.jsdelivr.net/npm/scanbot-web-sdk@8.0.1/bundle/bin/complete/";
    const sdk = await ScanbotSDK.initialize({
        enginePath: cdn,
        licenseKey: LICENSE_KEY
    });

    // ðŸ”¹ BACKEND URL (ADDED)
    const API_URL = "https://script.google.com/macros/s/AKfycbyK5cygiXq6DSHOa06UXSa6a1UxaDqEIMyOuJgcoYL2qmk1z2-LlO_TnV4Qs-9GhRx3/exec";

    document.getElementById("barcode-rtuui").onclick = async () => {

        const config = new ScanbotSDK.UI.Config.BarcodeScannerScreenConfiguration();

        // ðŸ”¹ OPTIONAL but recommended: QR only
        config.barcodeFormats = [ScanbotSDK.BarcodeFormat.QR_CODE];

        const result = await ScanbotSDK.UI.createBarcodeScanner(config);

        if (!result || !result.items || result.items.length === 0) {
            toast("No QR code detected");
            return;
        }

        // ðŸ”¹ THIS is the variable you asked for
        const scannedToken = result.items[0].barcode.text;

        // ðŸ”¹ Send token to backend
        sendToBackend(scannedToken);
    };

    // ðŸ”¹ BACKEND CALL (ADDED)
    async function sendToBackend(token) {
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "VERIFY",
                    token: token
                })
            });

            const data = await response.json();

            if (!data.success) {
                toast("Invalid token");
                return;
            }

            // Backend already decides what to show
            toast(data.display.text);

        } catch (err) {
            toast("Network error");
        }
    }

    document.getElementById("license-info").onclick = async () => {
        const result = await sdk.getLicenseInfo();
        let text = `License Information:\n`;
        text += `Status: ${result.status} (${result.licenseStatusMessage})\n`;
        text += `Expiration Date: ${new Date(result.expirationDateString).toLocaleDateString()}\n`;
        toast(text);
    };

    function toast(text) {
        Toastify({
            text: text,
            duration: 3000,
            gravity: "bottom",
            position: "center",
            style: {
                background: "linear-gradient(to right, #00b09b, #96c93d)",
                wordWrap: "break-word"
            },
        }).showToast();
    }
</script>

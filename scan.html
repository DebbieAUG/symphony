<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Symphony Entry Scanner</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QR Scanner Library -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body class="bg-black text-white min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md text-center space-y-6 px-4">

    <!-- HEADER -->
    <h1 class="text-2xl font-bold">
      ðŸŽ¶ Symphony Entry Scanner ðŸŽ¶
    </h1>
    <p class="text-base text-red-500 animate-pulse">Volunteer Access Only</p>

    <!-- IDLE -->
    <div id="idleState">
      <button
        onclick="startScanner()"
        class="w-full bg-green-600 hover:bg-green-700 p-4 rounded-xl font-semibold text-lg"
      >
        Start Scanning
      </button>
      <p class="text-sm text-zinc-400 mt-2">
        Point camera at QR code
      </p>
    </div>

    <!-- SCANNER -->
    <div id="scannerState" class="hidden">
      <div
        id="reader"
        class="rounded-lg overflow-hidden bg-black"
        style="width:100%; height:320px;"
    ></div>
    <p class="text-xs text-zinc-400 mt-2 animate-pulse">
      Looking for QR codeâ€¦
    </p>


      <p class="text-xs text-zinc-400 mt-2">Scanningâ€¦</p>
    </div>

    <!-- RESULT -->
    <div id="resultState" class="hidden rounded-xl p-6 space-y-3">
      <p id="resultTitle" class="text-2xl font-bold"></p>
      <p id="resultDetails" class="text-sm"></p>
    </div>

  </div>

<script>

  const API_URL = "https://script.google.com/macros/s/AKfycbyK5cygiXq6DSHOa06UXSa6a1UxaDqEIMyOuJgcoYL2qmk1z2-LlO_TnV4Qs-9GhRx3/exec";

  let html5QrCode;
  let scanInProgress = false;


  /* ---------- START SCANNER ---------- */
  function startScanner() {
    document.getElementById("idleState").classList.add("hidden");
    document.getElementById("scannerState").classList.remove("hidden");

    html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
      { facingMode: { exact: "environment" } },
      {
        fps: 10,
        aspectRatio: 1.0,
        disableFlip: true
      },
      onScanSuccess,
      error => {
        // Ignore scan errors (normal)
      }
    );

  }

  /* ---------- ON SCAN ---------- */
  async function onScanSuccess(decodedText) {
    if (scanInProgress) return; // ðŸ”’ prevent duplicate triggers
    scanInProgress = true;

    // Normalize token (VERY important)
    const token = decodedText.trim();

    console.log("QR detected:", token); // debug

    try {
      await html5QrCode.stop();
    } catch (e) {}

    document.getElementById("scannerState").classList.add("hidden");

    // Visual checkpoint (temporary)
    document.getElementById("resultState").classList.remove("hidden");
    document.getElementById("resultTitle").innerText = "SCAN DETECTED";
    document.getElementById("resultDetails").innerText = token;

    verifyToken(token);
  }


  /* ---------- VERIFY TOKEN ---------- */
  async function verifyToken(token) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "VERIFY",
          token: token
        })
      });

      const data = await res.json();

      showResult(data);

    } catch (err) {
      showError("Network Error");
    }
  }

  /* ---------- RESULT UI ---------- */
  function showResult(data) {
    const box = document.getElementById("resultState");
    const title = document.getElementById("resultTitle");
    const details = document.getElementById("resultDetails");

    box.classList.remove("hidden");

    if (!data.success) {
      box.className = "rounded-xl p-6 bg-red-700";
      title.innerText = "INVALID PASS";
      details.innerText = data.error;
      return resetLater();
    }

    if (data.entryStatus === "ENTERED") {
      box.className = "rounded-xl p-6 bg-red-700";
      title.innerText = "ALREADY ENTERED";
      details.innerText = data.token;
      return resetLater();
    }

    if (data.status === "CONFIRMED") {
      box.className = "rounded-xl p-6 bg-green-700";
      title.innerText = "ENTRY ALLOWED";
      details.innerText = data.token;
    } else {
      box.className = "rounded-xl p-6 bg-yellow-600 text-black";
      title.innerText = "PAYMENT PENDING";
      details.innerText = data.token;
    }

    resetLater();
  }

  /* ---------- ERROR ---------- */
  function showError(msg) {
    const box = document.getElementById("resultState");
    box.className = "rounded-xl p-6 bg-red-700";
    box.classList.remove("hidden");
    document.getElementById("resultTitle").innerText = msg;
    document.getElementById("resultDetails").innerText = "";
    resetLater();
  }

  /* ---------- RESET ---------- */
  function resetLater() {
    setTimeout(() => {
      scanInProgress = false; // ðŸ”“ unlock scanner
      document.getElementById("resultState").classList.add("hidden");
      document.getElementById("idleState").classList.remove("hidden");
    }, 2500);
  }

</script>

</body>
</html>
